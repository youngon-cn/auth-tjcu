"use strict";function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function n(a,o){try{var s=t[a](o),u=s.value}catch(e){return void r(e)}if(!s.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}return n("next")})}}var request=require("superagent"),cheerio=require("cheerio"),authServer=function(e,t){return new Promise(function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function r(n,a){var o,s,u,c,i,v,h,l,m,p,d,f,x,g;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return o="http://authserver.tjcu.edu.cn/authserver/login?service="+e,s=request.agent(),u=t.username,c=t.password,i=t.captcha,r.prev=3,r.next=6,s.get(o).timeout({response:6e3});case 6:return v=r.sent,h=cheerio.load(v.text),l=h("[name=lt]").val(),m=h("[name=dllt]").val(),p=h("[name=execution]").val(),d=h("[name=_eventId]").val(),f=h("[name=rmShown]").val(),r.next=15,s.post(o).type("form").set("Cookie",v.header["set-cookie"]).withCredentials().send({username:u,password:c,captchaRespon:i||0,lt:l,dllt:m,execution:p,_eventId:d,rmShown:f}).redirects(10);case 15:x=r.sent,x.redirects.length||(g=cheerio.load(x.text)("#msg").text(),n({state:0,msg:g})),n({state:1,cookies:x.request.cookies}),r.next=24;break;case 20:r.prev=20,r.t0=r.catch(3),"ETIMEDOUT"===r.t0.errno&&n({state:0,msg:"统一登录平台请求超时"}),a(r.t0);case 24:case"end":return r.stop()}},r,void 0,[[3,20]])}));return function(e,t){return r.apply(this,arguments)}}())};module.exports=authServer;